plotly
folium
koreanize_matplotlib
streamlit-folium
import streamlit as st
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(layout="wide", page_title="ê¸€ë¡œë²Œ ì‹œê°€ì´ì•¡ TOP 10 ê¸°ì—… ì£¼ê°€ ë³€í™” ğŸ“ˆ")

# ì•± ì œëª©
st.title("ğŸ’° ê¸€ë¡œë²Œ ì‹œê°€ì´ì•¡ TOP 10 ê¸°ì—… ì£¼ê°€ ë³€í™” ğŸ“ˆ")
st.markdown("---")

# ì•± ì†Œê°œ
st.write(
    """
    ì´ í˜ì´ì§€ì—ì„œëŠ” í˜„ì¬ ì „ ì„¸ê³„ ì‹œê°€ì´ì•¡ ìƒìœ„ 10ê°œ ê¸°ì—…(ì˜ˆì‹œ)ì˜ ì§€ë‚œ 3ë…„ê°„ ì£¼ê°€ ë³€í™”ë¥¼ ì¸í„°ë™í‹°ë¸Œí•œ ê·¸ë˜í”„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    ì‹¤ì‹œê°„ ì‹œê°€ì´ì•¡ ìˆœìœ„ì™€ ì£¼ê°€ëŠ” ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    """
)

# ì‹œê°€ì´ì•¡ TOP 10 ê¸°ì—… í‹°ì»¤ (2025ë…„ 5ì›” ë§ ê¸°ì¤€ ì˜ˆì‹œ)
# ì‹¤ì œ ì‹œê°€ì´ì•¡ ìˆœìœ„ëŠ” ë³€ë™ì„±ì´ í¬ë¯€ë¡œ, ìµœì‹  ì •ë³´ë¥¼ ë°˜ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
# (ì•ŒíŒŒë²³ GOOGì™€ GOOGLì€ ë™ì¼ ê¸°ì—…ì˜ ë‹¤ë¥¸ ì¢…ë¥˜ ì£¼ì‹ì…ë‹ˆë‹¤.)
top10_companies = {
    "AAPL": "Apple Inc.",
    "MSFT": "Microsoft Corp.",
    "NVDA": "NVIDIA Corp.",
    "GOOG": "Alphabet Inc. (GOOG)", # êµ¬ê¸€ í´ë˜ìŠ¤ A ì£¼ì‹
    "AMZN": "Amazon.com Inc.",
    "META": "Meta Platforms Inc.",
    "BRK-B": "Berkshire Hathaway Inc. (B shares)",
    "LLY": "Eli Lilly and Co.",
    "TSLA": "Tesla Inc.",
    "JPM": "JPMorgan Chase & Co." # ì˜ˆì‹œë¥¼ ìœ„í•´ 10ê°œ ë§ì¶¤
}

# ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜ë¶€í„° 3ë…„ ì „)
end_date = datetime.now()
start_date = end_date - timedelta(days=3 * 365) # 3ë…„ ì „ ë°ì´í„°

# ë°ì´í„° ë¡œë”© í•¨ìˆ˜ (ìºì‹± ì ìš©)
@st.cache_data
def load_data(ticker_list, start, end):
    data = {}
    for ticker, name in ticker_list.items():
        try:
            # yfinanceë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ì‹ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
            df = yf.download(ticker, start=start, end=end, progress=False)
            if not df.empty:
                data[ticker] = df['Adj Close'] # ìˆ˜ì • ì¢…ê°€ ì‚¬ìš©
            else:
                st.warning(f"ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {name} ({ticker})")
        except Exception as e:
            st.error(f"ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {name} ({ticker}) - {e}")
    return data

# ë°ì´í„° ë¡œë”©
stock_data = load_data(top10_companies, start_date, end_date)

st.subheader("ğŸ“Š ì§€ë‚œ 3ë…„ê°„ ì£¼ê°€ ë³€í™”")

if not stock_data:
    st.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
else:
    # ëª¨ë“  ì£¼ê°€ë¥¼ ì²«ë‚  ê°€ê²© ê¸°ì¤€ìœ¼ë¡œ ì •ê·œí™”í•˜ì—¬ ë³€í™”ìœ¨ ë¹„êµ
    normalized_data = pd.DataFrame()
    for ticker, series in stock_data.items():
        if not series.empty and len(series) > 0: # ë°ì´í„°ê°€ ì¡´ì¬í•˜ê³  ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
            normalized_data[top10_companies[ticker]] = (series / series.iloc[0]) * 100
        else:
            st.warning(f"ì •ê·œí™”í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤: {top10_companies[ticker]} ({ticker})")


    if not normalized_data.empty:
        # Plotly Figure ê°ì²´ ìƒì„± (ë¼ì¸ ê·¸ë˜í”„)
        fig = go.Figure()
        for col in normalized_data.columns:
            fig.add_trace(go.Scatter(x=normalized_data.index, y=normalized_data[col],
                                     mode='lines',
                                     name=col))

        # ê·¸ë˜í”„ ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸ (ì¸í„°ë™í‹°ë¸Œ ì„¤ì •)
        fig.update_layout(
            title_text='ì‹œê°€ì´ì•¡ TOP ê¸°ì—… ì£¼ê°€ ë³€í™”ìœ¨ (3ë…„ ê¸°ì¤€)',
            xaxis_title='ë‚ ì§œ',
            yaxis_title='ê°€ê²© ë³€í™”ìœ¨ (%) (ì²«ë‚  ê¸°ì¤€ 100%)',
            hovermode="x unified", # ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ xì¶• ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  ë°ì´í„° í‘œì‹œ
            height=600,
            template="plotly_white", # ê¹”ë”í•œ í…Œë§ˆ
            xaxis_rangeslider_visible=True, # ì•„ë˜ì— ë‚ ì§œ ë²”ìœ„ ìŠ¬ë¼ì´ë” í‘œì‹œ
            legend=dict( # ë²”ë¡€ ìœ„ì¹˜ ì¡°ì •
                orientation="h",
                yanchor="bottom",
                y=1.02,
                xanchor="right",
                x=1
            )
        )
        st.plotly_chart(fig, use_container_width=True)

        st.markdown("---")
        st.subheader("ğŸ“ˆ ê°œë³„ ê¸°ì—… ì£¼ê°€ ìƒì„¸ ë³´ê¸° (ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸)")

        # ê°œë³„ ê¸°ì—… ì„ íƒ ë“œë¡­ë‹¤ìš´
        selected_company_name = st.selectbox(
            "ìì„¸íˆ ë³´ê³  ì‹¶ì€ ê¸°ì—…ì„ ì„ íƒí•˜ì„¸ìš”:",
            list(top10_companies.values())
        )

        # ì„ íƒëœ ê¸°ì—…ì˜ í‹°ì»¤ ì°¾ê¸°
        selected_ticker = [k for k, v in top10_companies.items() if v == selected_company_name][0]

        if selected_ticker in stock_data:
            try:
                # ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ë¥¼ ìœ„í•œ Open, High, Low, Close ë°ì´í„° ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ
                ohlc_df = yf.download(selected_ticker, start=start_date, end=end_date, progress=False)

                if not ohlc_df.empty:
                    st.write(f"**{selected_company_name} ({selected_ticker})**ì˜ ì§€ë‚œ 3ë…„ê°„ ì£¼ê°€ ì°¨íŠ¸")
                    
                    # ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ ìƒì„±
                    fig_individual = go.Figure(data=[go.Candlestick(x=ohlc_df.index,
                                                                    open=ohlc_df['Open'],
                                                                    high=ohlc_df['High'],
                                                                    low=ohlc_df['Low'],
                                                                    close=ohlc_df['Close'],
                                                                    increasing_line_color='red', # ì–‘ë´‰ ìƒ‰ìƒ
                                                                    decreasing_line_color='blue' # ìŒë´‰ ìƒ‰ìƒ
                                                                    )])
                    fig_individual.update_layout(
                        title=f'{selected_company_name} ({selected_ticker}) ì£¼ê°€',
                        xaxis_title='ë‚ ì§œ',
                        yaxis_title='ì£¼ê°€ (USD)',
                        xaxis_rangeslider_visible=True # ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ì—ë„ ìŠ¬ë¼ì´ë” ìœ ì§€
                    )
                    st.plotly_chart(fig_individual, use_container_width=True)

                    st.write("---")
                    st.subheader("ë°ì´í„° í…Œì´ë¸”")
                    # 'Adj Close' ëŒ€ì‹  ì „ì²´ OHLCAV (Open, High, Low, Close, Adj Close, Volume) ë°ì´í„° í‘œì‹œ
                    st.dataframe(ohlc_df.reset_index().rename(columns={'index': 'ë‚ ì§œ'}), use_container_width=True)
                else:
                    st.warning(f"{selected_company_name}ì˜ ìƒì„¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            except Exception as e:
                st.error(f"{selected_company_name}ì˜ ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        else:
            st.warning(f"{selected_company_name}ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

st.markdown("---")
# íˆ¬ì ê²½ê³  ë¬¸êµ¬
st.markdown(
    """
    <div style="text-align: center; font-size: 0.9em; color: gray;">
        âš ï¸ ì£¼ì‹ íˆ¬ìëŠ” ì›ê¸ˆ ì†ì‹¤ì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ëŠ” íˆ¬ì ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤.
    </div>
    """,
    unsafe_allow_html=True
)
